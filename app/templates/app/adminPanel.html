{% extends 'index.html' %}
{% load static %}

{% block title %}Admin Panel{% endblock title %}

{% block body %}

<link rel="stylesheet" href="{% static '/styles/profile.css' %}">
<link rel="stylesheet" href="{% static '/styles/adminPanel.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css" integrity="sha256-2XFplPlrFClt0bIdPgpz8H7ojnk10H69xRqd9+uTShA=" crossorigin="anonymous" />


<div id="dashboard-page" class="container-fluid">
    <div class="row main-row">
        <!-- NAVBAR TAKING 1/12TH -->
        {% include 'app/navbar2.html' %}
        <!-- MAIN CONTENT TAKING 1/12TH -->
        <div class="col-md-11">
            {% comment %} <div class="container-fluid"> {% endcomment %}
                <div class="row ">
                    <div class="col-md-8 pe-0">
                        <div class="card mb-3 mx-0 " style="height: 95vh">
                            <div class="card-body pt-0">
                                <div class='row pt-0 px-0'>

                                    <div class='col pt-5 px-5 pb-0 pageTitle'>
                                        ADMIN PANEL
                                        <p class='titleFooter'>Welcome to the admin panel. Click on any user to modify details.<p>
                                    </div> 

                                    <div class='col mt-5 me-3 text-end'><a href="{% url 'add-user' %}"><button class="btn  btn-primary ">Add User</button></a>
                                    </div>
                                </div>

                                <div class="card-title mx-4 px-2 "><h4>All Users</h4></div>
                                <div class='ms-4 mb-3  tableDiv ' style="height: 65vh; overflow-y: auto;">
                                    <table class="table table-striped table-bordered table-hover" >
                                        <thead>
                                            <tr >
                                                <th>Username</th>
                                                <th>First Name</th>
                                                <th>Last Name</th>
                                                <th>Email</th>
                                                <th>Phone</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for user in users %}
                                            <tr onclick="selectUser('{{ user.id }}')">
                                                <td>{{ user.username }}</td>
                                                <td>{{ user.first_name }}</td>
                                                <td>{{ user.last_name }}</td>
                                                <td>{{ user.email }}</td>
                                                <td>{{ user.contact }}</td> {# Assuming phone is in the profile model #}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-4" >
                        <div class="card mb-4">
                            <div class="card-body" >
                                <h5>User Details</h5>
                                <div class='noInference' id='updateYeWalaDiv'>
                                    <div class="d-flex flex-column align-items-center justify-content-center">
                                        <!-- Placeholder SVG -->
                                        <span class="icon-circle icon-circle-lg bg-pastel-primary text-primary">
                                            <i class="fas fa-user-cog fa-lg"></i>
                                        </span>
                                        <p class="mt-3">You have not selected any user yet.</p>
                                    </div>
                                </div>
                                <div id="userDetailsContainer" style="display: none;">
                                    <form id="userDetailsForm" method="POST">
                                        {% csrf_token %}
                                        <div class='row'>
                                            <div class="col-md-6 mb-1">
                                                <input type="number" hidden class="form-control" id="userId" name="id"
                                                    disabled>

                                                <label for="username">Username</label>
                                                <input type="text" class="form-control " id="username" name="username"
                                                    disabled>
                                            </div>
                                            <div class="col-md-6 mb-1">
                                                <label for="contact">Contact</label>
                                                <input type="text" class="form-control" id="contact" name="contact"
                                                    disabled>
                                            </div>
                                        </div>
                                        <div class="form-group mb-1">
                                            <label for="email">Email</label>
                                            <input type="email" class="form-control" id="email" name="email" disabled>
                                        </div>
                                        
                                        <div class="form-group mb-1">
                                            <label for="is_admin">Is Admin</label>
                                            <input type="checkbox" id="is_admin" name="is_admin">
                                        </div>
                                        <button type="button" id="editUserBtn" class="btn btn-primary">Edit</button>
                                        <button type="button" id="deleteUserBtn" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                            <div id="loginHistory" class="card-body">
                                <h5>Login History</h5>
                                <div class='mb-3 mt-0 tableDiv ' style="max-height: 45vh; overflow-y: auto;">
                                    <table class="table table-striped " >
                                        <thead>
                                            <tr >
                                                <th>Date</th>
                                                <th>Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="loginHistoryContainer">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% comment %} </div> {% endcomment %}
        </div>
    </div>
</div>

<!-- Error messages -->
{% if messages %}
    {% for message in messages %}
        <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x mt-4" style="z-index: 1050">
            <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% endif %}"
                role="alert">
                {{ message }}
            </div>
        </div>
    {% endfor %}
    <script>
        // Automatically remove alert after 5 seconds
        $(document).ready(function () {
            setTimeout(function () {
                $('#alert-container').fadeOut();
            }, 2000);
        });
    </script>

    
{% endif %}


<script>
    function selectUser(userId) {
        $.ajax({
            url: '/get-user-details/' + userId + '/', // Endpoint to fetch user details
            type: 'GET',
            success: function(response) {
                console.log(response)
                $('#userId').val(response.id);
                $('#username').val(response.username);
                $('#email').val(response.email);
                $('#contact').val(response.contact);
                $('#is_admin').prop('checked', response.is_admin);
                $('#userDetailsContainer').css('display', 'block');
                $('#updateYeWalaDiv').css('display','none');
                var form = document.getElementById('userDetailsForm');
                // form.action = "{% url 'edit-user' user_id=0 %}".replace('0', response.id);
                var loginHistoryHtml = '';
            for (var i = 0; i < response.login_history.length; i++) {
                var history = response.login_history[i];
                var loginDate = history.login_time.slice(0, 10);
                var loginTime = history.login_time.slice(10);
                loginHistoryHtml += `<tr><td>${loginDate}</td><td>${loginTime}</tr>`;

            }
            $('#loginHistoryContainer').html(loginHistoryHtml);
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    }

    $('#editUserBtn').click(function() {
        var formData = $('#userDetailsForm').serialize();
        $.ajax({
            url: '/edit-user/' + $('#userId').val() + '/', // Form action URL
            type: 'POST',
            data: formData, // Form data to be submitted
            success: function(response) {
                // Handle success response
                console.log(response);
            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error(xhr.responseText);
            }
        });
    });

    $('#deleteUserBtn').click(function() {
        var userId = $('#userId').val();
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val(); // Get the CSRF token value

        $.ajax({
            url: '/delete-user/' + userId + '/', // URL for deleting the user
            type: 'POST', // Use POST method for deletion
            headers: {
                'X-CSRFToken': csrfToken // Include the CSRF token in the headers
            },
            success: function(response) {
                // Handle success response
                console.log(response);
                location.reload();
            },
            error: function(xhr, status, error) {
                // Handle error response
                console.error(xhr.responseText);
            }
        });
    });
</script>

{% endblock body %}
